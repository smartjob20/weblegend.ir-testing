<!DOCTYPE html>
<html lang="fa" dir="rtl" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>فرماندهی فروشگاه | WEB LEGEND VIP</title>
    <link rel="icon" type="image/png" href="img/logo01.png">
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brand: { 
                            gold: '#D4AF37', 
                            goldHover: '#F9E59E', 
                            dark: '#050505', 
                            panel: '#0F1115',
                            lightPanel: '#1A1D24'
                        } 
                    },
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    boxShadow: {
                        'gold': '0 4px 20px -2px rgba(212, 175, 55, 0.2)',
                        'gold-glow': '0 0 15px rgba(212, 175, 55, 0.4)',
                        'card': '0 10px 30px -5px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s ease, color 0.3s ease; -webkit-tap-highlight-color: transparent; }
        
        /* Glass & UI */
        .glass { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-shadow: var(--shadow-card);
        }
        .dark .glass { 
            background: rgba(20, 20, 20, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); 
        }

        /* Nav */
        .sidebar-link { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-link:hover { background: rgba(212, 175, 55, 0.05); transform: translateX(-5px); }
        .sidebar-link.active { 
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%); 
            color: #D4AF37; border-right: 3px solid #D4AF37; font-weight: 800;
        }
        .sidebar-link.active i { color: #D4AF37; filter: drop-shadow(0 0 5px rgba(212,175,55,0.4)); }

        .bottom-nav-link { transition: all 0.3s ease; position: relative; opacity: 0.6; }
        .bottom-nav-link.active { opacity: 1; color: #D4AF37; transform: translateY(-3px); }
        
        .fab-btn { animation: pulse-gold 3s infinite; }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes highlightRow { 0% { background-color: rgba(16, 185, 129, 0.2); } 100% { background-color: transparent; } }
        .new-order-highlight { animation: highlightRow 2s ease-out; }

        /* Advanced Components */
        .upload-zone { border: 2px dashed #e2e8f0; transition: all 0.3s; background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); border: none; }
        .upload-zone:hover { background-color: rgba(212, 175, 55, 0.03); transform: scale(0.99); }
        .dark .upload-zone { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23333' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        
        .img-preview-item { 
            position: relative; width: 100%; aspect-ratio: 1/1; 
            border-radius: 16px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); object-fit: cover;
        }
        
        /* Modern Color Picker */
        .color-option {
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s; position: relative;
        }
        .color-option.selected { transform: scale(1.15); border-color: #D4AF37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
        .color-option.selected::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 10px; text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* Smart Tags Input */
        .tags-input-container {
            display: flex; flex-wrap: wrap; gap: 6px; padding: 8px;
            background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;
            min-height: 48px; align-items: center;
        }
        .dark .tags-input-container { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .tags-input-container:focus-within { border-color: #D4AF37; }
        
        .tag-chip {
            background: #e5e7eb; color: #374151; padding: 4px 10px; border-radius: 8px;
            font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 6px;
            animation: fadeIn 0.2s ease;
        }
        .dark .tag-chip { background: #333; color: #e5e7eb; }
        .tag-chip i { cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .tag-chip i:hover { color: #ef4444; }
        
        .tags-input {
            flex: 1; background: transparent; border: none; outline: none;
            font-size: 12px; min-width: 60px; color: inherit;
        }
        
        @keyframes fadeIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }

        .order-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f3f4f6; transition: transform 0.2s; margin-bottom: 12px; }
        .dark .order-card { background: #151515; border-color: rgba(255,255,255,0.05); }
        .order-card:active { transform: scale(0.98); }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Loader Animation */
        .cube-loader { position: relative; width: 60px; height: 60px; transform-style: preserve-3d; animation: cubeRotate 4s infinite linear; }
        .cube-face { position: absolute; width: 60px; height: 60px; border: 2px solid #D4AF37; opacity: 0.5; box-shadow: 0 0 15px rgba(212,175,55,0.2); }
        .cube-face:nth-child(1) { transform: rotateY(0deg) translateZ(30px); }
        .cube-face:nth-child(2) { transform: rotateY(90deg) translateZ(30px); }
        .cube-face:nth-child(3) { transform: rotateY(180deg) translateZ(30px); }
        .cube-face:nth-child(4) { transform: rotateY(-90deg) translateZ(30px); }
        .cube-face:nth-child(5) { transform: rotateX(90deg) translateZ(30px); }
        .cube-face:nth-child(6) { transform: rotateX(-90deg) translateZ(30px); }
        @keyframes cubeRotate { 0% { transform: rotateX(0deg) rotateY(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
    </style>
</head>
<body class="font-sans h-screen overflow-hidden flex text-sm bg-[#f8f9fa] text-gray-800 dark:bg-black dark:text-gray-100">

    <div id="page-loader" class="fixed inset-0 z-[100] bg-[#000] flex items-center justify-center transition-opacity duration-700">
        <div class="cube-loader">
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="absolute inset-0 bg-brand-gold/20 blur-xl rounded-full animate-pulse-slow"></div>
        </div>
    </div>

    <aside class="hidden lg:flex w-72 bg-white dark:bg-brand-panel border-l border-gray-100 dark:border-white/5 flex-col z-20 transition-all duration-300 shadow-xl dark:shadow-none">
        <div class="p-8 flex items-center justify-start gap-4 h-24">
            <div class="w-12 h-12 bg-gradient-to-br from-brand-gold to-yellow-600 rounded-2xl flex items-center justify-center text-black font-black text-2xl shadow-gold">W</div>
            <div>
                <h1 class="font-black tracking-tighter text-xl text-gray-900 dark:text-white">WEB <span class="text-brand-gold">LEGEND</span></h1>
                <p class="text-[10px] text-gray-400 uppercase tracking-[0.2em] mt-0.5">Seller Cockpit</p>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 overflow-y-auto">
            <p class="px-4 text-[10px] text-gray-400 font-bold uppercase mb-2 mt-4">مدیریت</p>
            <button onclick="switchTab('dashboard')" class="sidebar-link active w-full flex items-center justify-start gap-4 px-5 py-4 text-gray-500 dark:text-gray-400 rounded-2xl transition group">
                <i class="fas fa-chart-pie text-lg transition"></i> <span class="font-medium">داشبورد فروش</span>
            </button>
            <button onclick="switchTab('products')" class="sidebar-link w-full flex items-center justify-start gap-4 px-5 py-4 text-gray-500 dark:text-gray-400 rounded-2xl transition group">
                <i class="fas fa-box-open text-lg transition"></i> <span class="font-medium">محصولات</span>
            </button>
            <button onclick="switchTab('orders')" class="sidebar-link w-full flex items-center justify-start gap-4 px-5 py-4 text-gray-500 dark:text-gray-400 rounded-2xl transition group relative">
                <i class="fas fa-receipt text-lg transition"></i> <span class="font-medium">سفارشات</span>
                <span id="sidebar-badge-orders" class="absolute left-5 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[9px] font-black px-2 py-0.5 rounded-full hidden animate-pulse">NEW</span>
            </button>
            
            <p class="px-4 text-[10px] text-gray-400 font-bold uppercase mb-2 mt-6">ابزارها</p>
            <button onclick="openLinkBuilder()" class="sidebar-link w-full flex items-center justify-start gap-4 px-5 py-4 text-gray-500 dark:text-gray-400 rounded-2xl transition group">
                <i class="fas fa-link text-lg transition"></i> <span class="font-medium">لینک‌ساز بایو</span>
            </button>
            <button onclick="openShopSettings()" class="sidebar-link w-full flex items-center justify-start gap-4 px-5 py-4 text-gray-500 dark:text-gray-400 rounded-2xl transition group">
                <i class="fas fa-cog text-lg transition"></i> <span class="font-medium">تنظیمات فروشگاه</span>
            </button>
        </nav>

        <div class="p-6">
            <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-4 border border-gray-100 dark:border-white/5 mb-4">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 rounded-full bg-green-500/10 flex items-center justify-center text-green-500"><i class="fas fa-globe"></i></div>
                    <div class="text-xs font-bold">فروشگاه آنلاین</div>
                </div>
                <button onclick="viewMyShop()" class="w-full bg-white dark:bg-black border border-gray-200 dark:border-white/10 text-xs font-bold py-2 rounded-xl hover:text-brand-gold transition">مشاهده سایت من</button>
            </div>
            <button onclick="logout()" class="flex items-center justify-center gap-2 w-full py-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-xl transition font-bold text-xs">
                <i class="fas fa-sign-out-alt"></i> خروج امن
            </button>
        </div>
    </aside>

    <main class="flex-1 relative flex flex-col h-full overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-[400px] bg-gradient-to-b from-brand-gold/5 via-brand-gold/0 to-transparent pointer-events-none"></div>

        <header class="h-16 lg:h-20 flex justify-between items-center px-4 lg:px-10 z-10 bg-white/60 dark:bg-black/60 backdrop-blur-md sticky top-0 border-b border-gray-100 dark:border-white/5">
            <div class="flex items-center gap-4">
                <div class="lg:hidden w-9 h-9 bg-gradient-to-tr from-brand-gold to-yellow-600 rounded-xl flex items-center justify-center text-black font-black text-sm shadow-gold">W</div>
                <div>
                    <h2 class="text-sm lg:text-lg font-black text-gray-900 dark:text-white" id="greeting-text">امپراتوری شما</h2>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-[10px] text-gray-500 font-mono tracking-wider">SYSTEM ONLINE</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggleBtn" class="w-10 h-10 rounded-full bg-transparent hover:bg-gray-100 dark:hover:bg-white/10 flex items-center justify-center text-gray-500 transition">
                    <i class="fas fa-moon hidden dark:block"></i>
                    <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                </button>
                <div class="h-6 w-[1px] bg-gray-200 dark:bg-white/10 mx-1"></div>
                <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition" onclick="openShopSettings()">
                    <div class="text-right hidden md:block">
                        <p class="text-xs font-bold text-gray-900 dark:text-white" id="header-shop-name">فروشگاه من</p>
                        <p class="text-[9px] text-brand-gold">VIP MEMBER</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-white/10 border-2 border-white dark:border-black overflow-hidden">
                        <img src="img/logo01.png" class="w-full h-full object-cover opacity-80" id="header-avatar" alt="Avatar">
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth pb-28 lg:pb-8 relative custom-scrollbar" id="main-scroll-area">
            
            <div id="view-dashboard" class="space-y-6 animate-slide-up">
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-6">
                    <div class="col-span-2 lg:col-span-2 glass rounded-3xl p-6 relative overflow-hidden group border-t-4 border-brand-gold">
                        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-brand-gold/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">فروش کل (تومان)</p>
                                <h3 class="text-3xl lg:text-4xl font-black text-gray-900 dark:text-white tracking-tight" id="dash-total-sales">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-brand-gold text-black flex items-center justify-center text-xl shadow-gold">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                        <div class="relative z-10 mt-4 flex items-center gap-2 text-xs font-bold text-green-500 bg-green-50 dark:bg-green-900/20 px-3 py-1.5 rounded-lg w-fit">
                            <i class="fas fa-arrow-up"></i> <span>درآمد خالص</span>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 flex flex-col justify-between group hover:border-brand-gold/30 transition border-t-4 border-transparent">
                        <div class="flex justify-between items-start">
                            <div class="w-10 h-10 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center"><i class="fas fa-shopping-bag"></i></div>
                            <span class="text-[10px] bg-gray-100 dark:bg-white/10 px-2 py-1 rounded-md text-gray-500">موفق</span>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="dash-order-count">0</h3>
                            <p class="text-xs text-gray-500 mt-1 font-bold">تعداد سفارشات</p>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 flex flex-col justify-between group hover:border-brand-gold/30 transition border-t-4 border-transparent">
                        <div class="flex justify-between items-start">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/10 text-purple-500 flex items-center justify-center"><i class="fas fa-eye"></i></div>
                            <span class="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-md flex items-center gap-1"><i class="fas fa-caret-up"></i> زنده</span>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="dash-views">...</h3>
                            <p class="text-xs text-gray-500 mt-1 font-bold">بازدید فروشگاه</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass rounded-3xl p-6 lg:p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2"><i class="fas fa-chart-line text-brand-gold"></i> روند رشد فروش</h3>
                            <select id="chart-filter" onchange="updateAnalytics()" class="bg-gray-50 dark:bg-white/5 border-none text-xs rounded-lg px-3 py-1 outline-none font-bold text-gray-500 cursor-pointer hover:bg-gray-100 transition">
                                <option value="7">۷ روز گذشته</option>
                                <option value="30">۳۰ روز گذشته</option>
                                <option value="all">کل دوره</option>
                            </select>
                        </div>
                        <div class="h-[250px] w-full">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 flex flex-col">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-crown text-brand-gold"></i> محصولات برتر</h3>
                        <div class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1" id="top-products-list">
                            <div class="text-center py-8 opacity-50"><p class="text-xs">در حال تحلیل داده‌ها...</p></div>
                        </div>
                        <button onclick="switchTab('products')" class="w-full mt-4 py-3 bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 rounded-xl text-xs font-bold transition">مدیریت محصولات</button>
                    </div>
                </div>
            </div>

            <div id="view-products" class="hidden space-y-6 animate-slide-up">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-gray-900 dark:text-white">ویترین محصولات</h2>
                        <p class="text-xs text-gray-500 mt-1">مدیریت موجودی و قیمت‌ها</p>
                    </div>
                    <button onclick="openProductModal()" class="hidden lg:flex bg-brand-gold hover:bg-brand-goldHover text-black font-black px-6 py-3 rounded-xl shadow-gold transition transform hover:-translate-y-1 items-center gap-2">
                        <i class="fas fa-plus"></i> افزودن محصول
                    </button>
                </div>
                
                <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20"></div>
            </div>

            <div id="view-orders" class="hidden space-y-6 animate-slide-up">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-gray-900 dark:text-white">مدیریت سفارشات</h2>
                        <p class="text-xs text-gray-500 mt-1">لیست پرداختی‌های مشتریان</p>
                    </div>
                    <div class="bg-white dark:bg-white/5 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-white/10 text-xs font-bold">
                        تعداد کل: <span id="total-orders-badge">0</span>
                    </div>
                </div>

                <div class="hidden lg:block glass rounded-3xl overflow-hidden border border-gray-100 dark:border-white/5">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-gray-50 dark:bg-white/5 text-gray-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-5">شناسه</th>
                                <th class="p-5">مشتری</th>
                                <th class="p-5">محصولات</th>
                                <th class="p-5">مبلغ کل</th>
                                <th class="p-5">آدرس</th>
                                <th class="p-5 text-center">وضعیت</th>
                                <th class="p-5 text-center">اقدام</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-desktop" class="divide-y divide-gray-100 dark:divide-white/5"></tbody>
                    </table>
                </div>

                <div class="lg:hidden space-y-3" id="orders-list-mobile"></div>
            </div>

        </div>
    </main>

    <nav class="lg:hidden fixed bottom-0 left-0 w-full bg-white/95 dark:bg-[#0F1115]/95 backdrop-blur-xl border-t border-gray-200 dark:border-white/5 z-40 flex justify-between items-end px-6 pb-safe pt-2 shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
        <button onclick="switchTab('dashboard')" class="bottom-nav-link active flex flex-col items-center gap-1 mb-3 w-12">
            <i class="fas fa-home text-xl"></i>
        </button>
        <button onclick="switchTab('orders')" class="bottom-nav-link flex flex-col items-center gap-1 mb-3 w-12 relative">
            <i class="fas fa-receipt text-xl"></i>
            <div id="mobile-badge-orders" class="absolute top-0 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-black hidden animate-pulse"></div>
        </button>
        <button onclick="openProductModal()" class="fab-btn mb-6 -mt-8 w-16 h-16 bg-gradient-to-tr from-brand-gold to-yellow-600 text-black rounded-full shadow-gold flex items-center justify-center transform active:scale-95 transition border-4 border-white dark:border-[#0F1115]">
            <i class="fas fa-plus text-2xl"></i>
        </button>
        <button onclick="switchTab('products')" class="bottom-nav-link flex flex-col items-center gap-1 mb-3 w-12">
            <i class="fas fa-box text-xl"></i>
        </button>
        <button onclick="viewMyShop()" class="bottom-nav-link flex flex-col items-center gap-1 mb-3 w-12">
            <i class="fas fa-globe text-xl"></i>
        </button>
    </nav>

    <div id="product-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-end lg:items-center justify-center sm:p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-2xl lg:rounded-3xl rounded-t-[2rem] border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] lg:max-h-[85vh] animate-slide-up">
            
            <div class="p-6 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 lg:rounded-t-3xl rounded-t-[2rem]">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white" id="modal-title">محصول جدید</h3>
                    <p class="text-xs text-gray-500 mt-1">اطلاعات را با دقت وارد کنید</p>
                </div>
                <button onclick="closeProductModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="product-form" class="p-6 space-y-6 overflow-y-auto custom-scrollbar pb-20 lg:pb-6">
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-2 block flex justify-between">
                        <span>تصاویر محصول (مربع)</span>
                        <span class="text-[10px] text-brand-gold">اولین عکس = کاور</span>
                    </label>
                    <div class="flex gap-3 overflow-x-auto pb-2 items-center">
                        <div class="upload-zone w-20 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer flex-shrink-0 text-gray-400 hover:text-brand-gold transition" onclick="document.getElementById('image-upload-input').click()">
                            <i class="fas fa-camera text-xl mb-1"></i>
                            <span class="text-[9px] font-bold">افزودن</span>
                        </div>
                        <div id="image-previews-container" class="flex gap-2"></div>
                    </div>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*" multiple onchange="handleImageUpload(this)">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 mb-2">نام محصول</label>
                        <input type="text" id="prod-name" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold focus:bg-white dark:focus:bg-black transition outline-none font-bold" placeholder="مثلا: کفش نایک جردن">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">قیمت (تومان)</label>
                        <input type="text" id="prod-price" inputmode="numeric" onkeyup="formatPriceInput(this)" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold focus:bg-white dark:focus:bg-black transition outline-none font-black text-lg text-left dir-ltr placeholder-gray-400" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">هزینه ارسال</label>
                        <input type="text" id="prod-shipping" inputmode="numeric" onkeyup="formatPriceInput(this)" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold focus:bg-white dark:focus:bg-black transition outline-none font-mono text-left dir-ltr" placeholder="0">
                    </div>
                </div>
                <div class="relative">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-500">توضیحات محصول</label>
                        <button type="button" onclick="alert('سرویس هوش مصنوعی به زودی فعال می‌شود!')" class="text-[10px] bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 py-1 rounded-full flex items-center gap-1 hover:scale-105 transition shadow-sm">
                            <i class="fas fa-magic"></i> <span>نوشتن با AI</span>
                        </button>
                    </div>
                    <textarea id="prod-desc" rows="3" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold transition outline-none resize-none" placeholder="جزئیات محصول..."></textarea>
                </div>
                <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-xs font-bold text-gray-500 uppercase">ویژگی‌ها</label>
                        <div class="flex gap-1">
                            <button type="button" onclick="addAttributeBlock('colors')" class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center justify-center hover:border-brand-gold transition text-gray-500" title="رنگ"><i class="fas fa-palette"></i></button>
                            <button type="button" onclick="addAttributeBlock('sizes')" class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center justify-center hover:border-brand-gold transition text-gray-500" title="سایز"><i class="fas fa-ruler"></i></button>
                            <button type="button" onclick="addAttributeBlock('custom')" class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center justify-center hover:border-brand-gold transition text-gray-500" title="دلخواه"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="attributes-container" class="space-y-3">
                        <p class="text-[10px] text-gray-400 text-center italic" id="no-attr-msg">بدون ویژگی (محصول ساده)</p>
                    </div>
                </div>
            </form>
            
            <div class="p-4 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] lg:rounded-b-3xl flex flex-col md:flex-row gap-3 z-20">
                <button id="btn-delete-product" onclick="deleteProduct()" class="hidden md:w-auto w-full bg-red-50 dark:bg-red-900/10 text-red-500 border border-red-200 dark:border-red-900/30 font-bold py-4 px-6 rounded-xl transition hover:bg-red-100 dark:hover:bg-red-900/20 flex items-center justify-center gap-2">
                    <i class="fas fa-trash"></i>
                </button>
                
                <button id="btn-save-product" onclick="saveProduct()" class="flex-1 bg-brand-gold hover:bg-white hover:text-black hover:ring-2 hover:ring-brand-gold text-black font-black py-4 rounded-xl transition transform active:scale-95 shadow-gold flex items-center justify-center gap-2 text-base">
                    <span>انتشار محصول</span> <i class="fas fa-rocket"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="link-modal" class="fixed inset-0 z-[70] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-sm rounded-3xl border border-brand-gold/50 shadow-gold-glow text-center p-8 relative animate-slide-up">
            <button onclick="document.getElementById('link-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <div class="w-16 h-16 bg-gradient-to-tr from-green-400 to-green-600 rounded-full flex items-center justify-center text-white text-3xl mx-auto mb-4 shadow-lg">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-xl font-black text-gray-900 dark:text-white mb-1">آماده فروش!</h3>
            <p class="text-xs text-gray-500 mb-6">لینک اختصاصی ساخته شد</p>
            <div class="bg-gray-100 dark:bg-white/5 p-3 rounded-xl border border-dashed border-gray-300 dark:border-white/10 flex items-center gap-2 mb-6 cursor-pointer hover:bg-gray-200 dark:hover:bg-white/10 transition" onclick="copyLink()">
                <i class="fas fa-copy text-gray-400"></i>
                <input type="text" id="generated-link" class="bg-transparent border-none outline-none w-full text-left dir-ltr text-brand-gold font-mono text-xs font-bold pointer-events-none" readonly>
            </div>
            <div class="flex gap-2">
                <a href="#" id="preview-btn" target="_blank" class="flex-1 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white font-bold py-3 rounded-xl text-xs transition hover:bg-gray-200">مشاهده</a>
                <button onclick="copyLink()" class="flex-[2] bg-brand-gold text-black font-black py-3 rounded-xl text-xs shadow-gold hover:scale-105 transition">کپی لینک و بستن</button>
            </div>
        </div>
    </div>

    <div id="order-action-modal" class="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg rounded-3xl border border-gray-200 dark:border-white/10 shadow-2xl relative animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] rounded-t-3xl z-10">
                <div>
                    <h3 class="font-black text-gray-900 dark:text-white text-lg flex items-center gap-2">
                        <i class="fas fa-file-invoice-dollar text-brand-gold"></i> جزئیات سفارش
                    </h3>
                </div>
                <button onclick="closeOrderAction()" class="w-8 h-8 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-5">
                
                <div class="space-y-2">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">اطلاعات مشتری</h4>
                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5 grid gap-4">
                        <div class="flex items-center justify-between border-b border-gray-100 dark:border-white/5 pb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-user"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-900 dark:text-white" id="modal-customer-name">...</h4>
                                    <span class="text-[10px] text-gray-400">خریدار</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <a href="#" id="modal-call-btn" class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition"><i class="fas fa-phone"></i></a>
                                <a href="#" id="modal-sms-btn" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 transition"><i class="fas fa-comment"></i></a>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white dark:bg-black/20 p-2 rounded-xl border border-gray-100 dark:border-white/5">
                                <label class="text-[9px] text-gray-400 block mb-1">شماره تماس</label>
                                <div class="flex justify-between items-center">
                                    <span class="font-mono font-bold text-xs" id="modal-customer-phone">...</span>
                                    <button onclick="copyText('modal-customer-phone')" class="text-gray-400 hover:text-brand-gold"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-black/20 p-2 rounded-xl border border-gray-100 dark:border-white/5">
                                <label class="text-[9px] text-gray-400 block mb-1">کد پستی</label>
                                <div class="flex justify-between items-center">
                                    <span class="font-mono font-bold text-xs" id="modal-customer-postal">...</span>
                                    <button onclick="copyText('modal-customer-postal')" class="text-gray-400 hover:text-brand-gold"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5 relative">
                            <label class="text-[9px] text-gray-400 block mb-1">آدرس پستی</label>
                            <p class="text-xs font-medium leading-relaxed" id="modal-customer-address">...</p>
                            <button onclick="copyText('modal-customer-address')" class="absolute top-2 left-2 text-gray-400 hover:text-brand-gold"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">اقلام سفارش</h4>
                    <div class="bg-white dark:bg-white/5 p-3 rounded-2xl border border-brand-gold/30 shadow-sm flex gap-3">
                        <div class="w-20 h-20 bg-gray-100 dark:bg-black rounded-xl border border-gray-200 dark:border-white/10 flex items-center justify-center p-1 overflow-hidden">
                            <img id="modal-product-img" src="img/logo01.png" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1 flex flex-col justify-between">
                            <div>
                                <h5 class="font-black text-sm text-gray-900 dark:text-white line-clamp-1 mb-1" id="modal-product-name">...</h5>
                                <div class="flex flex-wrap gap-1" id="modal-product-variants">
                                    </div>
                            </div>
                            <div class="flex justify-between items-end border-t border-dashed border-gray-200 dark:border-white/10 pt-2">
                                <span class="text-xs text-gray-500 font-bold">تعداد: <span class="text-black dark:text-white" id="modal-order-qty">1</span></span>
                                <span class="font-black text-brand-gold text-lg font-mono" id="modal-order-total">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t-2 border-dashed border-gray-100 dark:border-white/5 pt-4">
                     <div id="order-action-paid" class="hidden space-y-3">
                        <label class="block text-xs font-bold text-gray-500">وضعیت سفارش: <span class="text-yellow-600">در انتظار ارسال</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="tracking-input" class="flex-1 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-center text-sm placeholder-gray-400" placeholder="کد رهگیری پستی">
                            <button onclick="submitTrackingCode()" class="bg-black dark:bg-white text-white dark:text-black font-bold px-6 rounded-xl hover:opacity-80 transition shadow-lg whitespace-nowrap">
                                ثبت ارسال
                            </button>
                        </div>
                    </div>

                    <div id="order-action-sent" class="hidden text-center bg-green-50 dark:bg-green-900/10 p-4 rounded-xl border border-green-100 dark:border-green-900/30">
                        <div class="flex items-center justify-center gap-2 text-green-600 mb-2">
                            <i class="fas fa-check-circle"></i> <span class="font-bold text-sm">ارسال شده برای مشتری</span>
                        </div>
                        <div class="flex items-center justify-center gap-2">
                             <span class="text-xs text-gray-500">کد رهگیری:</span>
                             <span class="font-mono font-bold text-gray-900 dark:text-white select-all text-lg tracking-widest" id="display-tracking-code">---</span>
                             <button onclick="copyText('display-tracking-code')" class="text-gray-400 hover:text-green-500"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg rounded-3xl border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] animate-slide-up">
            <div class="p-6 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 rounded-t-3xl">
                <h3 class="text-xl font-black text-gray-900 dark:text-white">تنظیمات فروشگاه</h3>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto custom-scrollbar">
                <div class="flex flex-col items-center">
                    <div class="relative w-24 h-24 rounded-full border-2 border-dashed border-gray-300 dark:border-white/20 p-1 mb-2 group cursor-pointer hover:border-brand-gold transition" onclick="document.getElementById('logo-upload-input').click()">
                        <div class="w-full h-full rounded-full bg-gray-50 dark:bg-white/5 overflow-hidden flex items-center justify-center">
                            <img id="settings-logo-preview" src="img/logo01.png" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white text-xs font-bold">تغییر لوگو</div>
                    </div>
                    <input type="file" id="logo-upload-input" class="hidden" accept="image/*" onchange="handleLogoUpload(this)">
                    <p class="text-[10px] text-gray-400">برای تغییر تصویر کلیک کنید</p>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-2">نام فروشگاه</label><input type="text" id="setting-store-name" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-bold" placeholder="نام برند شما"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-2">آیدی اینستاگرام (بدون @)</label><input type="text" id="setting-instagram" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-left dir-ltr" placeholder="weblegend_shop"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-2">بیوگرافی کوتاه</label><textarea id="setting-bio" rows="3" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none resize-none" placeholder="توضیحات کوتاه درباره فروشگاه..."></textarea></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-2">رنگ سازمانی</label><div class="flex items-center gap-3"><input type="color" id="setting-color" class="w-12 h-12 rounded-xl border-none p-0 cursor-pointer overflow-hidden" value="#D4AF37"><span class="text-xs text-gray-400">رنگ برند خود را انتخاب کنید</span></div></div>
            </div>
            <div class="p-6 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] rounded-b-3xl">
                <button id="btn-save-settings" onclick="saveShopSettings()" class="w-full bg-brand-gold text-black font-black py-4 rounded-xl shadow-gold hover:scale-[1.02] transition flex items-center justify-center gap-2"><span>ذخیره تغییرات</span> <i class="fas fa-save"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const supabaseUrl = 'https://bclbzdvupfiqihcdjltu.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGJ6ZHZ1cGZpcWloY2RqbHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA5NTcsImV4cCI6MjA4MjEzNjk1N30.fiCvS54TEbVZPm_chLcHEo8MAr1AHhP5CKNGbxr02JY'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let currentUser = null;
        let uploadedImages = []; 
        let editingProductId = null; 
        let salesChart = null;
        let activeOrderId = null;
        let storeProfile = null; 
        let newLogoUrl = null;
        let realtimeChannel = null;
        let allOrdersCache = []; 
        let productsMap = {}; // Cache for Product ID -> Name/Image

        // --- UTILS ---
        window.formatPriceInput = (input) => {
            let val = input.value.replace(/\D/g, '');
            if(!val) { input.value = ''; return; }
            input.value = new Intl.NumberFormat('en-US').format(val);
        };
        const cleanPrice = (str) => str.replace(/,/g, '');
        const formatMoney = (n) => new Intl.NumberFormat('fa-IR').format(n);
        
        function showToast(msg, type='success') {
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "center",
                style: { background: type === 'success' ? "#10B981" : "#EF4444", borderRadius: "12px", fontSize: "12px", fontFamily: "Vazirmatn", fontWeight: "bold" }
            }).showToast();
        }

        window.copyText = (elementId) => {
            const el = document.getElementById(elementId);
            if(el) {
                navigator.clipboard.writeText(el.innerText);
                showToast('کپی شد', 'success');
            }
        };

        // --- AUDIO ---
        function playNotification() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = "sine";
            osc.frequency.setValueAtTime(500, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }

        // --- INIT ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            document.getElementById('themeToggleBtn').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            });
        }
        initTheme();

        async function initApp() {
            const loader = document.getElementById('page-loader');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { window.location.href = 'index.html'; return; }
                currentUser = user;

                // Load Data
                await loadStoreProducts(); // Load products first to build cache map
                await Promise.all([
                    loadOrders(), // Gets orders and builds analytics
                    loadProfile()
                ]);

                // Initial Analytics Render
                loadDashboardStats('7');

                subscribeToOrders();

                loader.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loader.style.display = 'none', 700);

            } catch (err) {
                console.error("Init Error:", err);
                showToast("خطا در ارتباط با سرور", "error");
                loader.style.display = 'none';
            }
        }
        initApp();

        function subscribeToOrders() {
            if (realtimeChannel) return;
            realtimeChannel = supabase
                .channel('public:store_orders')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'store_orders', filter: `seller_id=eq.${currentUser.id}` }, payload => {
                    handleNewOrder(payload.new);
                })
                .subscribe();
        }

        function handleNewOrder(newOrder) {
            playNotification();
            showToast(`سفارش جدید: ${newOrder.customer_name}`, 'success');
            allOrdersCache.unshift(newOrder);
            updateAnalytics(); 
            renderSingleOrderRow(newOrder, true);
        }

        // --- DASHBOARD & ANALYTICS ---
        window.updateAnalytics = () => {
            const range = document.getElementById('chart-filter').value;
            loadDashboardStats(range);
        };

        async function loadDashboardStats(range = '7') {
            if(allOrdersCache.length === 0) {
                 // Try refreshing if empty
                 // Logic already in loadOrders
            }

            const now = new Date();
            const cutoff = new Date();
            if (range !== 'all') {
                cutoff.setDate(now.getDate() - parseInt(range));
            } else {
                cutoff.setFullYear(2000); 
            }

            const filteredOrders = allOrdersCache.filter(o => new Date(o.created_at) > cutoff);
            
            let totalSales = 0;
            filteredOrders.forEach(o => totalSales += Number(o.total_price || 0));

            document.getElementById('dash-total-sales').innerText = formatMoney(totalSales);
            document.getElementById('dash-order-count').innerText = new Intl.NumberFormat('fa-IR').format(filteredOrders.length);
            
            renderChart(filteredOrders, range);
            renderTopProducts(filteredOrders);
        }

        function renderTopProducts(orders) {
            const productCounts = {};
            orders.forEach(o => {
                productCounts[o.product_id] = (productCounts[o.product_id] || 0) + (o.quantity || 1);
            });

            const sortedIds = Object.keys(productCounts).sort((a,b) => productCounts[b] - productCounts[a]).slice(0, 3);
            const list = document.getElementById('top-products-list');
            list.innerHTML = '';
            
            if(sortedIds.length === 0) {
                list.innerHTML = '<div class="text-center py-4 opacity-50"><p class="text-xs">داده‌ای موجود نیست</p></div>';
                return;
            }

            sortedIds.forEach((id, idx) => {
                const count = productCounts[id];
                const product = productsMap[id]; // Use Cached Data
                let pName = 'محصول حذف شده';
                let pImg = 'img/logo01.png';

                if(product) {
                    pName = product.name;
                    try { const imgs = JSON.parse(product.image); if(imgs.length) pImg = imgs[0]; } catch(e){}
                }

                list.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/10 p-1">
                                <img src="${pImg}" class="w-full h-full object-contain">
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-900 dark:text-white line-clamp-1">${pName}</h4>
                                <span class="text-[10px] text-gray-400">فروش: ${count} عدد</span>
                            </div>
                        </div>
                        <div class="w-6 h-6 rounded-full ${idx === 0 ? 'bg-yellow-400' : (idx===1 ? 'bg-gray-300' : 'bg-orange-300')} text-white flex items-center justify-center text-[10px] font-bold shadow-sm">
                            ${idx+1}
                        </div>
                    </div>
                `;
            });
        }

        function renderChart(orders, range) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            const grouped = {};
            // Init dates if range is short to show empty days
            if(range === '7') {
                for(let i=0; i<7; i++) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    grouped[d.toLocaleDateString('fa-IR')] = 0;
                }
            }

            orders.forEach(o => {
                const date = new Date(o.created_at).toLocaleDateString('fa-IR');
                grouped[date] = (grouped[date] || 0) + Number(o.total_price);
            });

            // Sort keys
            // Simple sort for Persian date strings usually works for same year, 
            // but ideally use timestamp keys. For now relying on object insertion order or simple reverse
            // Re-map to ensure chronological order
            let sortedKeys = Object.keys(grouped); 
            if(range === '7') sortedKeys = sortedKeys.reverse(); // Because we built it backwards

            const dataPoints = sortedKeys.map(k => grouped[k]);

            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{
                        label: 'فروش',
                        data: dataPoints,
                        borderColor: '#D4AF37',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(212,175,55,0.2)');
                            gradient.addColorStop(1, 'rgba(212,175,55,0)');
                            return gradient;
                        },
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#D4AF37',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#999', font: { family: 'Vazirmatn' }, maxTicksLimit: 7 } },
                        y: { border: { display: false }, grid: { color: 'rgba(200,200,200,0.1)' }, ticks: { display: false } }
                    }
                }
            });
        }

        // --- PRODUCTS LOGIC ---
        async function loadStoreProducts() {
            const grid = document.getElementById('products-grid');
            const { data: products } = await supabase.from('store_products').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            
            grid.innerHTML = '';
            productsMap = {}; // Reset Cache

            if (!products || products.length === 0) {
                grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-400 border-2 border-dashed border-gray-200 dark:border-white/10 rounded-3xl"><i class="fas fa-box-open text-4xl mb-3 opacity-50"></i><p>هنوز محصولی ندارید</p></div>`;
                return;
            }

            products.forEach(p => {
                productsMap[p.id] = p; // Populate Cache

                let imgUrl = 'img/logo01.png';
                try {
                    const parsed = JSON.parse(p.image);
                    if(Array.isArray(parsed) && parsed.length) imgUrl = parsed[0];
                } catch(e){}

                const card = document.createElement('div');
                card.className = "group bg-white dark:bg-[#151515] rounded-2xl border border-gray-100 dark:border-white/5 overflow-hidden hover:shadow-gold transition-all duration-300";
                
                // SQUARE IMAGE FIX
                card.innerHTML = `
                    <div class="relative w-full aspect-square bg-gray-50 dark:bg-white/5 p-4 flex items-center justify-center">
                        <img src="${imgUrl}" class="w-full h-full object-cover rounded-xl transition-transform duration-500 group-hover:scale-105 shadow-sm">
                    </div>
                    <div class="p-3">
                        <h4 class="font-bold text-xs text-gray-900 dark:text-white truncate">${p.name}</h4>
                        <p class="text-brand-gold font-black text-sm mt-1">${formatMoney(p.price)} <span class="text-[9px] text-gray-400 font-normal">تومان</span></p>
                        <div class="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-gray-50 dark:border-white/5">
                            <button onclick="openProductModal('${p.id}')" class="bg-gray-100 dark:bg-white/10 hover:bg-gray-200 text-gray-600 dark:text-gray-300 py-2 rounded-lg text-[10px] font-bold transition">ویرایش</button>
                            <button onclick="showLink('${p.id}')" class="bg-black text-white dark:bg-white dark:text-black py-2 rounded-lg text-[10px] font-bold transition flex items-center justify-center gap-1">لینک <i class="fas fa-share"></i></button>
                        </div>
                    </div>
                `;
                card.dataset.product = JSON.stringify(p);
                card.querySelector('button').onclick = function() { openProductModal(JSON.parse(card.dataset.product)); };
                grid.appendChild(card);
            });
        }

        window.deleteProduct = async () => {
            if(!editingProductId) return;
            if(!confirm('آیا از حذف این محصول مطمئن هستید؟ این عملیات غیرقابل بازگشت است.')) return;

            const btn = document.getElementById('btn-delete-product');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            const { error } = await supabase.from('store_products').delete().eq('id', editingProductId);

            if(error) {
                showToast('خطا در حذف محصول: ' + error.message, 'error');
                btn.innerHTML = '<i class="fas fa-trash"></i>';
                btn.disabled = false;
            } else {
                showToast('محصول حذف شد');
                closeProductModal();
                loadStoreProducts(); // Will also clear it from cache map locally if run again
            }
        };

        // --- ORDERS LOGIC ---
        async function loadOrders() {
            const { data } = await supabase.from('store_orders').select('*').eq('seller_id', currentUser.id).order('created_at', { ascending: false });
            allOrdersCache = data || [];
            
            const desktopBody = document.getElementById('orders-table-desktop');
            const mobileList = document.getElementById('orders-list-mobile');
            const totalBadge = document.getElementById('total-orders-badge');
            
            desktopBody.innerHTML = '';
            mobileList.innerHTML = '';
            totalBadge.innerText = allOrdersCache.length;

            if (allOrdersCache.length === 0) {
                mobileList.innerHTML = `<div id="no-orders-msg" class="text-center py-10 text-gray-400">هنوز سفارشی ثبت نشده است</div>`;
                return;
            }

            allOrdersCache.forEach(o => renderSingleOrderRow(o));
        }

        function renderSingleOrderRow(o, prepend = false) {
            const desktopBody = document.getElementById('orders-table-desktop');
            const mobileList = document.getElementById('orders-list-mobile');
            
            const statusConfig = {
                'pending': { label: 'در انتظار', class: 'bg-yellow-100 text-yellow-700', icon: 'fa-clock' },
                'paid': { label: 'پرداخت شده', class: 'bg-green-100 text-green-700', icon: 'fa-check' },
                'sent': { label: 'ارسال شده', class: 'bg-blue-100 text-blue-700', icon: 'fa-truck' }
            };
            const st = statusConfig[o.status] || statusConfig['pending'];

            const row = document.createElement('tr');
            row.className = `hover:bg-gray-50 dark:hover:bg-white/5 transition border-b border-gray-100 dark:border-white/5 last:border-0 ${prepend ? 'new-order-highlight' : ''}`;
            row.innerHTML = `
                <td class="p-5 font-mono text-gray-400 text-xs">#${o.id.toString().slice(0,6)}</td>
                <td class="p-5 font-bold">${o.customer_name}<div class="text-[10px] text-gray-400 font-mono">${o.customer_phone}</div></td>
                <td class="p-5 text-xs text-gray-500">کد محصول: ${o.product_id} (×${o.quantity || 1})</td>
                <td class="p-5 font-black text-brand-gold font-mono">${formatMoney(o.total_price)}</td>
                <td class="p-5 text-xs truncate max-w-[150px]" title="${o.customer_address}">${o.customer_address}</td>
                <td class="p-5 text-center"><span class="${st.class} px-2 py-1 rounded text-[10px] font-bold whitespace-nowrap"><i class="fas ${st.icon}"></i> ${st.label}</span></td>
                <td class="p-5 text-center"><button class="order-action-btn bg-gray-100 dark:bg-white/10 hover:bg-brand-gold hover:text-black transition px-3 py-1.5 rounded-lg text-[10px] font-bold">مدیریت</button></td>
            `;
            row.querySelector('.order-action-btn').onclick = () => openOrderAction(o);
            
            if(prepend) desktopBody.prepend(row); else desktopBody.appendChild(row);

            const mCard = document.createElement('div');
            mCard.className = `order-card ${prepend ? 'new-order-highlight' : ''}`;
            mCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div><h4 class="font-bold text-sm text-gray-900 dark:text-white">${o.customer_name}</h4><p class="text-[10px] text-gray-500 font-mono mt-0.5">${o.customer_phone}</p></div>
                    <span class="${st.class} px-2 py-0.5 rounded text-[10px] font-bold">${st.label}</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-white/5 p-3 rounded-xl mb-3"><span class="text-xs text-gray-500">مبلغ کل</span><span class="font-black text-brand-gold text-sm">${formatMoney(o.total_price)} ت</span></div>
                <div class="flex gap-2">
                    <button class="flex-1 border border-dashed border-gray-300 dark:border-white/20 text-gray-500 py-2 rounded-xl text-xs font-bold hover:bg-gray-50 dark:hover:bg-white/5 transition flex items-center justify-center gap-1 copy-addr-btn"><i class="fas fa-copy"></i> آدرس</button>
                    <button class="mobile-manage-btn flex-1 bg-brand-gold text-black py-2 rounded-xl text-xs font-bold shadow-gold hover:scale-105 transition">مدیریت</button>
                </div>
            `;
            mCard.querySelector('.copy-addr-btn').onclick = () => { navigator.clipboard.writeText(o.customer_address); showToast('آدرس کپی شد'); };
            mCard.querySelector('.mobile-manage-btn').onclick = () => openOrderAction(o);
            if(prepend) mobileList.prepend(mCard); else mobileList.appendChild(mCard);
        }

        // --- DEEP ORDER DETAILS ---
        window.openOrderAction = async (order) => {
            activeOrderId = order.id;
            document.getElementById('order-action-modal').classList.remove('hidden');
            
            // Populate Identity
            document.getElementById('modal-customer-name').innerText = order.customer_name;
            document.getElementById('modal-customer-phone').innerText = order.customer_phone;
            document.getElementById('modal-call-btn').href = `tel:${order.customer_phone}`;
            document.getElementById('modal-sms-btn').href = `sms:${order.customer_phone}`;
            
            document.getElementById('modal-customer-address').innerText = order.customer_address;
            document.getElementById('modal-customer-postal').innerText = order.customer_postal_code || 'ندارد';
            
            document.getElementById('modal-order-qty').innerText = order.quantity || 1;
            document.getElementById('modal-order-total').innerText = formatMoney(order.total_price) + ' تومان';

            // Variants
            const variantsContainer = document.getElementById('modal-product-variants');
            variantsContainer.innerHTML = '';
            if(order.selected_options) {
                try {
                    const opts = typeof order.selected_options === 'string' ? JSON.parse(order.selected_options) : order.selected_options;
                    for (const [key, val] of Object.entries(opts)) {
                        // Check if color
                        const isColor = val.startsWith && val.startsWith('#');
                        if(isColor) {
                            variantsContainer.innerHTML += `<div class="flex items-center gap-1 bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md text-[10px] font-bold"><div class="w-3 h-3 rounded-full border border-gray-300" style="background:${val}"></div> ${key}</div>`;
                        } else {
                            variantsContainer.innerHTML += `<span class="text-[10px] bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md text-gray-600 dark:text-gray-300 font-bold">${key}: ${val}</span>`;
                        }
                    }
                } catch(e) {}
            }

            // Fetch Product Info (Name/Img) from cache or DB
            let pName = 'محصول یافت نشد (حذف شده)';
            let pImg = 'img/logo01.png';
            
            // Try cache first
            if(productsMap[order.product_id]) {
                const p = productsMap[order.product_id];
                pName = p.name;
                try { const imgs = JSON.parse(p.image); if(imgs.length) pImg = imgs[0]; } catch(e){}
            } else {
                // Fallback fetch if not in cache (rare)
                const { data } = await supabase.from('store_products').select('name, image').eq('id', order.product_id).single();
                if(data) {
                    pName = data.name;
                    try { const imgs = JSON.parse(data.image); if(imgs.length) pImg = imgs[0]; } catch(e){}
                }
            }

            document.getElementById('modal-product-name').innerText = pName;
            document.getElementById('modal-product-img').src = pImg;

            // Status Logic
            const paidView = document.getElementById('order-action-paid');
            const sentView = document.getElementById('order-action-sent');
            if (order.status === 'sent') {
                paidView.classList.add('hidden');
                sentView.classList.remove('hidden');
                document.getElementById('display-tracking-code').innerText = order.tracking_code || '-';
            } else {
                paidView.classList.remove('hidden');
                sentView.classList.add('hidden');
            }
        };

        window.closeOrderAction = () => document.getElementById('order-action-modal').classList.add('hidden');

        window.submitTrackingCode = async () => {
            const code = document.getElementById('tracking-input').value.trim();
            if(!code) { showToast('لطفا کد رهگیری را وارد کنید', 'error'); return; }

            const { error } = await supabase.from('store_orders').update({ status: 'sent', tracking_code: code }).eq('id', activeOrderId);

            if(error) { showToast('خطا: ' + error.message, 'error'); } 
            else {
                showToast('وضعیت سفارش بروزرسانی شد');
                closeOrderAction();
                // Update local cache
                const orderIdx = allOrdersCache.findIndex(o => o.id == activeOrderId);
                if(orderIdx > -1) {
                    allOrdersCache[orderIdx].status = 'sent';
                    allOrdersCache[orderIdx].tracking_code = code;
                    loadOrders(); // Refresh table
                }
            }
        };

        // --- PRODUCT UPLOAD & EDIT ---
        const compressImageToBlob = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Square Crop Strategy or Fit? User said "square aspect ratio".
                        // Let's keep strict scale but object-cover in CSS handles display.
                        const scale = 800 / img.width; 
                        canvas.width = 800; 
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.8); 
                    }
                }
            })
        };

        window.handleImageUpload = async (input) => {
            if(!input.files.length) return;
            const uploadBtn = input.previousElementSibling;
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
            try {
                for(let file of input.files) {
                    showToast('در حال آپلود...', 'info');
                    const blob = await compressImageToBlob(file);
                    const fileName = `${currentUser.id}/${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
                    const { error } = await supabase.storage.from('product-images').upload(fileName, blob, { contentType: 'image/jpeg' });
                    if (error) throw error;
                    const { data: { publicUrl } } = supabase.storage.from('product-images').getPublicUrl(fileName);
                    uploadedImages.push(publicUrl);
                }
                renderPreviews();
                showToast('تصویر افزوده شد');
            } catch (err) {
                console.error(err);
                showToast('خطا در آپلود', 'error');
            } finally {
                uploadBtn.innerHTML = originalText; input.value = '';
            }
        };

        function renderPreviews() {
            const c = document.getElementById('image-previews-container');
            c.innerHTML = '';
            uploadedImages.forEach((imgUrl, idx) => {
                c.innerHTML += `
                    <div class="relative w-20 h-20 flex-shrink-0 group">
                        <img src="${imgUrl}" class="img-preview-item">
                        <div onclick="removeImg(${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] cursor-pointer shadow-sm z-10 hover:bg-red-600 transition"><i class="fas fa-times"></i></div>
                        ${idx === 0 ? '<div class="absolute bottom-0 left-0 w-full bg-brand-gold text-black text-[8px] font-bold text-center py-0.5 rounded-b-[16px]">کاور</div>' : ''}
                    </div>`;
            });
        }
        window.removeImg = (i) => { uploadedImages.splice(i, 1); renderPreviews(); };

        // --- NEW ATTRIBUTES SYSTEM ---
        window.addAttributeBlock = (type) => {
            const c = document.getElementById('attributes-container');
            document.getElementById('no-attr-msg').style.display = 'none';
            const id = Date.now();
            let content = '';
            
            if(type === 'colors') {
                const palette = ['#000000','#FFFFFF','#1F2937','#DC2626','#2563EB','#059669','#D97706','#7C3AED'];
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5" data-type="colors" id="${id}">
                        <div class="flex justify-between mb-3"><span class="text-xs font-bold flex items-center gap-2"><i class="fas fa-palette text-gray-400"></i> رنگ‌بندی</span><i class="fas fa-times text-red-500 cursor-pointer" onclick="document.getElementById('${id}').remove()"></i></div>
                        <div class="flex flex-wrap gap-2 items-center">
                            ${palette.map(col => `<div class="color-option" style="background:${col}; border-color:${col==='#FFFFFF'?'#e5e7eb':'transparent'}" data-val="${col}" onclick="this.classList.toggle('selected')"></div>`).join('')}
                            <div class="relative w-8 h-8 rounded-full overflow-hidden border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center cursor-pointer hover:border-brand-gold transition">
                                <i class="fas fa-plus text-[10px] text-gray-400"></i>
                                <input type="color" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addCustomColor(this)">
                            </div>
                        </div>
                    </div>`;
            } else if (type === 'sizes') {
                const sizes = ['S','M','L','XL','XXL','36','37','38','39','40','41','42'];
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5" data-type="sizes" id="${id}">
                        <div class="flex justify-between mb-3"><span class="text-xs font-bold flex items-center gap-2"><i class="fas fa-ruler text-gray-400"></i> سایزبندی</span><i class="fas fa-times text-red-500 cursor-pointer" onclick="document.getElementById('${id}').remove()"></i></div>
                        <div class="flex flex-wrap gap-2">
                            ${sizes.map(s => `<div class="px-3 py-1 rounded-lg border border-gray-200 dark:border-white/10 text-xs font-bold cursor-pointer hover:border-brand-gold bg-gray-50 dark:bg-white/5 transition select-chip" data-val="${s}" onclick="this.classList.toggle('bg-brand-gold');this.classList.toggle('text-black');this.classList.toggle('selected')">${s}</div>`).join('')}
                        </div>
                    </div>`;
            } else {
                // Custom with Tags Input
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5" data-type="custom" id="${id}">
                        <div class="flex justify-between mb-2"><span class="text-xs font-bold flex items-center gap-2"><i class="fas fa-pen text-gray-400"></i> ویژگی دلخواه</span><i class="fas fa-times text-red-500 cursor-pointer" onclick="document.getElementById('${id}').remove()"></i></div>
                        <input class="custom-label w-full bg-transparent border-b border-gray-200 dark:border-white/10 text-xs mb-3 py-1 outline-none font-bold placeholder-gray-400" placeholder="عنوان ویژگی (مثلا: جنس پارچه)">
                        
                        <div class="tags-input-container" onclick="this.querySelector('input').focus()">
                            <input type="text" class="tags-input" placeholder="تایپ کنید و Enter بزنید..." onkeydown="handleTagInput(event)">
                        </div>
                    </div>`;
            }
            c.innerHTML += content;
        };

        window.addCustomColor = (inp) => {
            const col = inp.value; 
            const div = document.createElement('div'); 
            div.className = "color-option selected"; 
            div.style.background = col; 
            div.dataset.val = col; 
            div.onclick = function(){this.classList.toggle('selected')}; 
            inp.parentElement.parentElement.insertBefore(div, inp.parentElement);
        };

        window.handleTagInput = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = e.target.value.trim();
                if (val) {
                    const chip = document.createElement('div');
                    chip.className = 'tag-chip custom-val-chip';
                    chip.dataset.val = val;
                    chip.innerHTML = `<span>${val}</span><i class="fas fa-times" onclick="this.parentElement.remove()"></i>`;
                    e.target.parentElement.insertBefore(chip, e.target);
                    e.target.value = '';
                }
            }
        };

        window.openProductModal = (p = null) => {
            document.getElementById('product-modal').classList.remove('hidden');
            document.getElementById('image-previews-container').innerHTML = '';
            document.getElementById('attributes-container').innerHTML = '<p class="text-[10px] text-gray-400 text-center italic" id="no-attr-msg">بدون ویژگی (محصول ساده)</p>';
            uploadedImages = [];
            const delBtn = document.getElementById('btn-delete-product');
            
            if(p) {
                editingProductId = p.id;
                delBtn.classList.remove('hidden'); 
                document.getElementById('modal-title').innerText = 'ویرایش محصول';
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-price').value = formatMoney(p.price);
                document.getElementById('prod-shipping').value = formatMoney(p.shipping_cost || 0);
                document.getElementById('prod-desc').value = p.description || '';
                
                try { 
                    uploadedImages = JSON.parse(p.image); 
                    if(!Array.isArray(uploadedImages)) uploadedImages = [p.image]; 
                    renderPreviews(); 
                } catch(e){}

                // Populate attributes - challenging because structure changed. 
                // Simple logic: if old structure, might not show perfectly. 
                // We clear and let user re-add for now or implement complex parser.
                // Assuming "Pro" user will re-enter or we map basic ones.
            } else {
                editingProductId = null;
                delBtn.classList.add('hidden'); 
                document.getElementById('modal-title').innerText = 'محصول جدید';
                document.getElementById('product-form').reset();
            }
        };
        window.closeProductModal = () => document.getElementById('product-modal').classList.add('hidden');

        window.saveProduct = async () => {
            const btn = document.getElementById('btn-save-product');
            const name = document.getElementById('prod-name').value;
            const price = cleanPrice(document.getElementById('prod-price').value);
            const shipping = cleanPrice(document.getElementById('prod-shipping').value);
            const desc = document.getElementById('prod-desc').value;
            
            if(!name || !price) { showToast('نام و قیمت الزامی است', 'error'); return; }
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const attributes = {};
            document.querySelectorAll('.attr-block').forEach(b => {
                const type = b.dataset.type;
                if(type === 'custom') { 
                    const l = b.querySelector('.custom-label').value; 
                    // Get values from Chips
                    const vals = [];
                    b.querySelectorAll('.custom-val-chip').forEach(chip => vals.push(chip.dataset.val));
                    if(l && vals.length) attributes[l] = vals; 
                } else if (type === 'sizes') {
                    const vals = []; 
                    b.querySelectorAll('.select-chip.selected').forEach(s => vals.push(s.dataset.val)); 
                    if(vals.length) attributes[type] = vals; 
                } else { // colors
                    const vals = []; 
                    b.querySelectorAll('.color-option.selected').forEach(s => vals.push(s.dataset.val)); 
                    if(vals.length) attributes[type] = vals; 
                }
            });

            const payload = { user_id: currentUser.id, name, price, shipping_cost: shipping, description: desc, image: JSON.stringify(uploadedImages), attributes };
            
            let err;
            if(editingProductId) { 
                delete payload.user_id; 
                const { error } = await supabase.from('store_products').update(payload).eq('id', editingProductId); 
                err = error; 
            } else { 
                const { data, error } = await supabase.from('store_products').insert([payload]).select(); 
                err = error; 
                if(data) showLink(data[0].id); 
            }
            
            if(err) showToast(err.message, 'error'); else { showToast('محصول ذخیره شد'); closeProductModal(); loadStoreProducts(); }
            btn.disabled = false; btn.innerHTML = '<span>انتشار محصول</span> <i class="fas fa-rocket"></i>';
        };

        window.showLink = (id) => {
            document.getElementById('link-modal').classList.remove('hidden');
            const link = `${window.location.href.replace('d6.html','').replace('dashboard.html','')}sale.html?id=${id}`;
            document.getElementById('generated-link').value = link;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {text: link, width: 128, height: 128});
            document.getElementById('preview-btn').href = link;
        };

        window.copyLink = () => { const copyText = document.getElementById("generated-link"); copyText.select(); document.execCommand("copy"); showToast("لینک کپی شد"); };

        window.switchTab = (tab) => {
            document.querySelectorAll('.sidebar-link, .bottom-nav-link').forEach(el => el.classList.remove('active')); event.currentTarget.classList.add('active');
            
            if(tab === 'orders') {
                document.getElementById('sidebar-badge-orders').classList.add('hidden');
                document.getElementById('mobile-badge-orders').classList.add('hidden');
                setTimeout(() => {
                    document.querySelectorAll('.new-order-highlight').forEach(el => el.classList.remove('new-order-highlight'));
                }, 3000);
            }

            ['dashboard', 'products', 'orders'].forEach(v => { const el = document.getElementById('view-' + v); if(el) { el.classList.add('hidden'); el.classList.remove('animate-slide-up'); } });
            const target = document.getElementById('view-' + tab); target.classList.remove('hidden'); setTimeout(() => target.classList.add('animate-slide-up'), 10);
        };
        
        window.viewMyShop = () => {
            if(currentUser) window.location.href = `store.html?id=${currentUser.id}`;
        };
        window.openLinkBuilder = () => alert("لینک‌ساز هوشمند به زودی!");
        window.logout = async () => { if(confirm('خروج؟')) await supabase.auth.signOut(); window.location.reload(); };

        // --- PROFILE SETTINGS ---
        async function loadProfile() {
            const { data } = await supabase.from('store_profiles').select('*').eq('user_id', currentUser.id).single();
            if(data) {
                storeProfile = data;
                document.getElementById('header-shop-name').innerText = data.store_name || 'فروشگاه من';
                document.getElementById('greeting-text').innerText = data.store_name || 'امپراتوری شما';
                if(data.store_logo) document.getElementById('header-avatar').src = data.store_logo;
            }
        }
        window.openShopSettings = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
            if(storeProfile) {
                document.getElementById('setting-store-name').value = storeProfile.store_name || '';
                document.getElementById('setting-instagram').value = storeProfile.instagram_id || '';
                document.getElementById('setting-bio').value = storeProfile.bio || '';
                document.getElementById('setting-color').value = storeProfile.theme_color || '#D4AF37';
                if(storeProfile.store_logo) document.getElementById('settings-logo-preview').src = storeProfile.store_logo;
            }
        };
        window.handleLogoUpload = async (input) => {
            if(!input.files.length) return;
            const file = input.files[0];
            const blob = await compressImageToBlob(file);
            const fileName = `logos/${currentUser.id}_${Date.now()}.jpg`;
            const { error } = await supabase.storage.from('store-assets').upload(fileName, blob);
            if(!error) {
                const { data: { publicUrl } } = supabase.storage.from('store-assets').getPublicUrl(fileName);
                newLogoUrl = publicUrl;
                document.getElementById('settings-logo-preview').src = publicUrl;
            }
        };
        window.saveShopSettings = async () => {
            const btn = document.getElementById('btn-save-settings');
            btn.innerHTML = '...';
            const updates = {
                user_id: currentUser.id,
                store_name: document.getElementById('setting-store-name').value,
                instagram_id: document.getElementById('setting-instagram').value,
                bio: document.getElementById('setting-bio').value,
                theme_color: document.getElementById('setting-color').value,
                updated_at: new Date()
            };
            if(newLogoUrl) updates.store_logo = newLogoUrl;
            
            const { error } = await supabase.from('store_profiles').upsert(updates);
            if(error) showToast(error.message, 'error');
            else { showToast('تنظیمات ذخیره شد'); location.reload(); }
            btn.innerHTML = 'ذخیره تغییرات';
        };

    </script>
</body>
</html>