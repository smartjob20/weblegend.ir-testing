<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>فروشگاه آنلاین | WebLegend Store</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: { 
                            gold: 'var(--brand-color)', 
                            goldLight: '#F9E59E',
                            dark: '#111827',
                            gray: '#f9fafb',
                            surface: '#ffffff',
                            border: '#e5e7eb'
                        } 
                    },
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    },
                    boxShadow: {
                        'digi': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'digi-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --brand-color: #D4AF37; /* Default, gets updated via JS */
        }
        body { background-color: #f8f9fa; color: #374151; -webkit-tap-highlight-color: transparent; }
        
        /* --- Header Styling --- */
        .store-header-bg {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            position: relative; overflow: hidden;
            padding-bottom: 4rem; /* More space for search */
        }
        .store-header-bg::after {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at top right, var(--brand-color), transparent 60%);
            opacity: 0.2; pointer-events: none; mix-blend-mode: overlay;
        }

        /* --- Sticky Search --- */
        .sticky-search-container {
            position: sticky; top: 0; z-index: 40;
            margin-top: -30px; padding: 10px 16px;
            transition: all 0.3s ease;
        }
        .sticky-search-container.is-stuck {
             background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
             margin-top: 0;
        }
        .search-input-box {
            background: var(--brand-surface);
            border: 1px solid var(--brand-border);
            box-shadow: var(--shadow-digi);
            border-radius: 12px; /* Slightly less rounded for professional look */
            transition: all 0.3s;
        }
        .search-input-box:focus-within { border-color: var(--brand-color); }

        /* --- Digi-Style Product Card --- */
        .product-card {
            background: var(--brand-surface);
            border: 1px solid var(--brand-border);
            border-radius: 12px; /* Cleaner corner radius */
            overflow: hidden;
            display: flex; flex-direction: column;
            height: 100%;
            transition: all 0.3s ease;
            position: relative;
        }
        .product-card:hover { box-shadow: var(--shadow-digi-hover); border-color: #d1d5db; transform: translateY(-2px); }
        
        .card-image-container {
            position: relative; width: 100%; aspect-ratio: 1/1; /* Square for clean grid */
            background: #fff; padding: 10px;
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid var(--brand-border);
        }
        .card-image-container img {
            width: 100%; height: 100%; object-fit: contain;
            transition: transform 0.3s ease;
            mix-blend-mode: multiply; /* Helps images blend better with white background */
        }
        .product-card:hover .card-image-container img { transform: scale(1.05); }

        /* New Skeleton Styles */
        .skeleton-box { background-color: #e5e7eb; border-radius: 8px; }

        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col">

    <div id="main-app" class="flex-1 flex flex-col transition-opacity duration-500">
        
        <header class="store-header-bg text-white pt-8 px-6 rounded-b-[2.5rem] shadow-xl z-10 relative">
            <div class="max-w-md mx-auto relative z-20 pb-6 flex flex-col items-center">
                <div class="relative w-24 h-24 mb-3 group cursor-pointer">
                    <div class="absolute inset-0 bg-brand-gold blur-xl opacity-40 rounded-full animate-pulse-slow"></div>
                    <img id="store-logo" src="img/logo01.png" class="w-full h-full rounded-full object-cover relative z-10 border-2 border-white/20 shadow-md bg-white" onerror="this.src='https://via.placeholder.com/100?text=Store'">
                </div>
                
                <h1 class="text-xl font-black mb-1 drop-shadow-sm tracking-tight text-center" id="store-name">فروشگاه در حال بارگذاری...</h1>
                <p class="text-xs text-gray-300 mb-4 max-w-[90%] mx-auto leading-relaxed opacity-90 font-medium text-center line-clamp-2" id="store-bio"></p>
                
                <div class="flex justify-center gap-3" id="social-links">
                    </div>
            </div>
        </header>

        <div class="sticky-search-container max-w-md mx-auto w-full" id="sticky-search">
            <div class="search-input-box flex items-center px-4 py-3">
                <i class="fas fa-search text-gray-400 text-lg ml-2"></i>
                <input type="text" id="search-input" placeholder="جستجو در بین محصولات..." class="w-full bg-transparent outline-none text-sm font-medium text-gray-700 placeholder-gray-400">
            </div>
        </div>

        <main class="flex-1 px-4 pb-20 max-w-5xl mx-auto w-full mt-4">
            <div class="flex justify-between items-center mb-4 px-1">
                 <h2 class="text-base font-black text-gray-800 flex items-center gap-2">
                    <i class="fas fa-fire text-brand-gold"></i> پرفروش‌ترین‌ها
                </h2>
                <span class="text-[10px] text-gray-500 font-bold bg-white border border-brand-border px-3 py-1 rounded-full shadow-sm animate-pulse-slow" id="products-count">...</span>
            </div>

            <div id="products-container" class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                </div>

             <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 opacity-0 transition-opacity duration-500">
                <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 text-gray-300 text-3xl border-2 border-dashed border-gray-200">
                    <i class="fas fa-box-open"></i>
                </div>
                <p class="text-gray-500 font-bold text-sm">محصولی یافت نشد!</p>
            </div>
        </main>

        <footer class="bg-white border-t border-gray-100 py-6 text-center text-[10px] text-gray-400 font-bold mt-auto pb-safe">
            <div class="flex items-center justify-center gap-1 text-gray-700 opacity-60">
                 <span>قدرت گرفته از</span> <span class="font-black text-brand-gold uppercase">WebLegend</span>
            </div>
        </footer>

    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const supabaseUrl = 'https://bclbzdvupfiqihcdjltu.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGJ6ZHZ1cGZpcWloY2RqbHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA5NTcsImV4cCI6MjA4MjEzNjk1N30.fiCvS54TEbVZPm_chLcHEo8MAr1AHhP5CKNGbxr02JY'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let allProducts = [];
        let sellerId = null;

        // Handle Sticky Search Bar Appearance
        const searchContainer = document.getElementById('sticky-search');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) { searchContainer.classList.add('is-stuck'); } 
            else { searchContainer.classList.remove('is-stuck'); }
        });

        async function initStore() {
            const container = document.getElementById('products-container');
            // 1. RENDER SKELETONS IMMEDIATELY (New Loading Experience)
            renderSkeletons(6); 

            const urlParams = new URLSearchParams(window.location.search);
            sellerId = urlParams.get('id');

            if (!sellerId) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400 font-bold">لینک فروشگاه معتبر نیست.</div>';
                document.getElementById('products-count').innerText = 'خطا';
                return;
            }

            try {
                // 2. Fetch Data
                const [profileRes, productsRes] = await Promise.all([
                    supabase.from('store_profiles').select('*').eq('user_id', sellerId).single(),
                    supabase.from('store_products').select('*').eq('user_id', sellerId).eq('is_active', true).order('created_at', { ascending: false })
                ]);

                // 3. Apply Theme & Profile
                if (profileRes.data) applyStoreIdentity(profileRes.data);

                // 4. Render Real Products (Replace Skeletons)
                allProducts = productsRes.data || [];
                // Small delay to smooth transition
                setTimeout(() => {
                     renderProducts(allProducts);
                     setupSearch();
                }, 300);

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div class="col-span-full text-center py-10 text-red-400 font-bold">خطا در بارگذاری اطلاعات</div>`;
            }
        }

        // NEW FUNCTION: Renders In-Place Skeletons matching the new card design
        function renderSkeletons(count) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                container.innerHTML += `
                    <div class="product-card animate-pulse-slow border-gray-100">
                        <div class="aspect-square bg-gray-100 p-4">
                            <div class="skeleton-box w-full h-full bg-gray-200"></div>
                        </div>
                        <div class="p-3 flex flex-col flex-1 justify-between gap-3 bg-white">
                            <div class="space-y-2">
                                <div class="skeleton-box h-4 w-3/4 bg-gray-200"></div>
                                <div class="skeleton-box h-4 w-1/2 bg-gray-200"></div>
                            </div>
                            <div class="flex justify-between items-end mt-2">
                                <div class="skeleton-box h-5 w-1/3 bg-gray-200 rounded-md"></div>
                                <div class="skeleton-box w-8 h-8 bg-gray-200 rounded-lg"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('products-count').innerText = 'در حال بارگذاری...';
        }

        function applyStoreIdentity(profile) {
            if (profile.theme_color) {
                document.documentElement.style.setProperty('--brand-color', profile.theme_color);
            }
            if (profile.store_name) {
                document.getElementById('store-name').innerText = profile.store_name;
                document.title = `${profile.store_name}`;
            }
            if (profile.bio) document.getElementById('store-bio').innerText = profile.bio;
            if (profile.store_logo) document.getElementById('store-logo').src = profile.store_logo;

            const socialContainer = document.getElementById('social-links');
            let socialHtml = '';
            if (profile.instagram_id) {
                socialHtml += `<a href="https://instagram.com/${profile.instagram_id.replace('@','')}" target="_blank" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-brand-gold hover:text-black transition backdrop-blur-md border border-white/10"><i class="fab fa-instagram text-lg"></i></a>`;
            }
            socialHtml += `<button onclick="shareStore()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-brand-gold hover:text-black transition backdrop-blur-md border border-white/10"><i class="fas fa-share-alt text-lg"></i></button>`;
            socialContainer.innerHTML = socialHtml;
        }

        function renderProducts(products) {
            const container = document.getElementById('products-container');
            const emptyState = document.getElementById('empty-state');
            const countBadge = document.getElementById('products-count');

            container.innerHTML = '';
            countBadge.innerText = `${products.length} کالا`;
            countBadge.classList.remove('animate-pulse-slow'); // Stop pulsing

            if (products.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                setTimeout(() => emptyState.classList.remove('opacity-0'), 50);
                return;
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }

            products.forEach((p, index) => {
                let imgUrl = 'img/logo01.png';
                try {
                    const parsed = JSON.parse(p.image);
                    if(Array.isArray(parsed) && parsed.length > 0) imgUrl = parsed[0];
                } catch(e){}

                const price = new Intl.NumberFormat('fa-IR').format(p.price);
                // Staggered entry animation
                const delay = Math.min(index * 0.05, 0.5); 

                const card = document.createElement('a');
                card.href = `sale.html?id=${p.id}`; 
                card.className = 'product-card group animate-slide-up block h-full text-right';
                card.style.animationDelay = `${delay}s`;
                
                // --- NEW DIGI-STYLE CARD STRUCTURE ---
                card.innerHTML = `
                    <div class="card-image-container relative">
                        <img src="${imgUrl}" loading="lazy" alt="${p.name}">
                        ${p.short_description ? `<div class="absolute bottom-2 right-2 bg-red-500 text-white text-[9px] px-2 py-0.5 rounded-full font-bold shadow-sm">${p.short_description}</div>` : ''}
                    </div>
                    
                    <div class="p-3 flex flex-col flex-1 justify-between">
                        <h3 class="font-bold text-xs text-gray-700 leading-6 line-clamp-2 mb-3 min-h-[3rem]">
                            ${p.name}
                        </h3>
                        
                        <div class="flex items-end justify-between gap-2 mt-auto pt-2 border-t border-dashed border-gray-100">
                            <div class="flex flex-col items-start">
                                <div class="text-brand-gold font-black text-base flex items-center gap-1">
                                    <span>${price}</span>
                                    <span class="text-[10px] text-gray-400 font-medium">تومان</span>
                                </div>
                            </div>
                            <button class="w-8 h-8 rounded-lg bg-gray-50 text-brand-gold border border-gray-200 flex items-center justify-center hover:bg-brand-gold hover:text-white transition shadow-sm active:scale-95">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function setupSearch() {
            const input = document.getElementById('search-input');
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
                renderProducts(filtered);
            });
        }

        window.shareStore = () => {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(window.location.href);
                Toastify({
                    text: "لینک فروشگاه کپی شد", duration: 3000, 
                    style: { background: "#10B981", borderRadius: "10px", fontSize: "12px", fontFamily: "Vazirmatn" }
                }).showToast();
            }
        };

        // Start with skeletons first!
        initStore();
    </script>
</body>
</html>